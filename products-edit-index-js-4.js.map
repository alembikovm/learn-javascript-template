{"version":3,"sources":["webpack:///./src/components/product-form/index.js","webpack:///./src/pages/products/edit/index.js","webpack:///./src/utils/fetch-json.js","webpack:///./src/utils/escape-html.js","webpack:///./src/components/sortable-list/index.js"],"names":["ProductForm","constructor","productId","title","description","quantity","subcategory","status","images","price","discount","event","preventDefault","this","save","fileInput","document","createElement","type","accept","onchange","async","file","files","formData","FormData","uploadImage","imageListContainer","subElements","append","classList","add","disabled","result","fetchJson","method","headers","Authorization","body","firstElementChild","getImageItem","data","link","name","remove","hidden","appendChild","click","template","createCategoriesSelect","defaultFormData","categoriesPromise","loadCategoriesList","productPromise","loadProductData","Promise","resolve","categoriesData","productResponse","all","productData","categories","renderForm","setFormData","createImagesList","initEventListeners","element","innerHTML","getEmptyTemplate","getSubElements","product","getFormData","JSON","stringify","dispatchEvent","id","productForm","excludedFields","formatToNumber","fields","Object","keys","filter","item","includes","values","field","parseInt","value","imagesHTMLCollection","querySelectorAll","image","push","url","src","source","alt","CustomEvent","detail","forEach","querySelector","wrapper","select","category","child","subcategories","Option","outerHTML","elements","dataset","items","map","sortableList","SortableList","escapeHtml","addEventListener","onSubmit","destroy","Page","match","render","components","initComponents","renderComponents","component","root","$element","reduce","accum","subElement","params","response","fetch","toString","err","FetchError","ok","errorText","statusText","json","error","message","Error","super","window","reason","alert","string","replace","clientX","clientY","moveDraggingAt","children","top","firstElementTop","getBoundingClientRect","bottom","movePlaceholderAt","length","i","li","draggingElem","offsetHeight","height","scrollIfCloseToWindowEdge","dragStop","className","addItems","onPointerDown","which","itemElem","target","closest","dragStart","elementInitialIndex","indexOf","pointerInitialShift","x","y","placeholderElem","style","width","offsetWidth","after","onDocumentPointerMove","onDocumentPointerUp","left","scrollBy","documentElement","clientHeight","index","currentElement","insertBefore","placeholderIndex","replaceWith","removeEventListener","bubbles","details","from","to"],"mappings":"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","file":"products-edit-index-js-4.js","sourcesContent":["import SortableList from '../sortable-list/index.js';\r\nimport escapeHtml from '../../utils/escape-html.js';\r\nimport fetchJson from '../../utils/fetch-json.js';\r\n\r\nexport default class ProductForm {\r\n  element;\r\n  subElements = {};\r\n  defaultFormData = {\r\n    title: '',\r\n    description: '',\r\n    quantity: 1,\r\n    subcategory: '',\r\n    status: 1,\r\n    images: [],\r\n    price: 100,\r\n    discount: 0\r\n  };\r\n\r\n  onSubmit = event => {\r\n    event.preventDefault();\r\n\r\n    this.save();\r\n  };\r\n\r\n  uploadImage = () => {\r\n    const fileInput = document.createElement('input');\r\n\r\n    fileInput.type = 'file';\r\n    fileInput.accept = 'image/*';\r\n\r\n    fileInput.onchange = async () => {\r\n      const [file] = fileInput.files;\r\n\r\n      if (file) {\r\n        const formData = new FormData();\r\n        const {uploadImage, imageListContainer} = this.subElements;\r\n\r\n        formData.append('image', file);\r\n\r\n        uploadImage.classList.add('is-loading');\r\n        uploadImage.disabled = true;\r\n\r\n        const result = await fetchJson('https://api.imgur.com/3/image', {\r\n          method: 'POST',\r\n          headers: {\r\n            Authorization: `Client-ID ${process.env.IMGUR_CLIENT_ID}`\r\n          },\r\n          body: formData,\r\n        });\r\n\r\n        imageListContainer.firstElementChild.append(this.getImageItem(result.data.link, file.name));\r\n\r\n        uploadImage.classList.remove('is-loading');\r\n        uploadImage.disabled = false;\r\n\r\n        // Remove input from body\r\n        fileInput.remove();\r\n      }\r\n    };\r\n\r\n    // must be in body for IE\r\n    fileInput.hidden = true;\r\n    document.body.appendChild(fileInput);\r\n    fileInput.click();\r\n  };\r\n\r\n  constructor(productId) {\r\n    this.productId = productId;\r\n  }\r\n\r\n  template() {\r\n    return `\r\n      <div class=\"product-form\">\r\n\r\n      <form data-element=\"productForm\" class=\"form-grid\">\r\n        <div class=\"form-group form-group__half_left\">\r\n          <fieldset>\r\n            <label class=\"form-label\">Название товара</label>\r\n            <input required\r\n              id=\"title\"\r\n              value=\"\"\r\n              type=\"text\"\r\n              name=\"title\"\r\n              class=\"form-control\"\r\n              placeholder=\"Название товара\">\r\n          </fieldset>\r\n        </div>\r\n\r\n        <div class=\"form-group form-group__wide\">\r\n          <label class=\"form-label\">Описание</label>\r\n          <textarea required\r\n            id=\"description\"\r\n            class=\"form-control\"\r\n            name=\"description\"\r\n            placeholder=\"Описание товара\"></textarea>\r\n        </div>\r\n\r\n        <div class=\"form-group form-group__wide\">\r\n          <label class=\"form-label\">Фото</label>\r\n\r\n          <div data-element=\"imageListContainer\"></div>\r\n\r\n          <button data-element=\"uploadImage\" type=\"button\" class=\"button-primary-outline\">\r\n            <span>Загрузить</span>\r\n          </button>\r\n        </div>\r\n\r\n        <div class=\"form-group form-group__half_left\">\r\n          <label class=\"form-label\">Категория</label>\r\n            ${this.createCategoriesSelect()}\r\n        </div>\r\n\r\n        <div class=\"form-group form-group__half_left form-group__two-col\">\r\n          <fieldset>\r\n            <label class=\"form-label\">Цена ($)</label>\r\n            <input required\r\n              id=\"price\"\r\n              value=\"\"\r\n              type=\"number\"\r\n              name=\"price\"\r\n              class=\"form-control\"\r\n              placeholder=\"${this.defaultFormData.price}\">\r\n          </fieldset>\r\n          <fieldset>\r\n            <label class=\"form-label\">Скидка ($)</label>\r\n            <input required\r\n              id=\"discount\"\r\n              value=\"\"\r\n              type=\"number\"\r\n              name=\"discount\"\r\n              class=\"form-control\"\r\n              placeholder=\"${this.defaultFormData.discount}\">\r\n          </fieldset>\r\n        </div>\r\n\r\n        <div class=\"form-group form-group__part-half\">\r\n          <label class=\"form-label\">Количество</label>\r\n          <input required\r\n            id=\"quantity\"\r\n            value=\"\"\r\n            type=\"number\"\r\n            class=\"form-control\"\r\n            name=\"quantity\"\r\n            placeholder=\"${this.defaultFormData.quantity}\">\r\n        </div>\r\n\r\n        <div class=\"form-group form-group__part-half\">\r\n          <label class=\"form-label\">Статус</label>\r\n          <select id=\"status\" class=\"form-control\" name=\"status\">\r\n            <option value=\"1\">Активен</option>\r\n            <option value=\"0\">Неактивен</option>\r\n          </select>\r\n        </div>\r\n\r\n        <div class=\"form-buttons\">\r\n          <button type=\"submit\" name=\"save\" class=\"button-primary-outline\">\r\n            ${this.productId ? 'Сохранить' : 'Добавить'} товар\r\n          </button>\r\n        </div>\r\n      </form>\r\n    </div>\r\n    `;\r\n  }\r\n\r\n  async render() {\r\n    const categoriesPromise = this.loadCategoriesList();\r\n    const productPromise = this.productId\r\n      ? this.loadProductData(this.productId)\r\n      : Promise.resolve([this.defaultFormData]);\r\n\r\n    const [categoriesData, productResponse] = await Promise.all([categoriesPromise, productPromise]);\r\n    const [productData] = productResponse;\r\n\r\n    this.formData = productData;\r\n    this.categories = categoriesData;\r\n\r\n    this.renderForm();\r\n    this.setFormData();\r\n    this.createImagesList();\r\n    this.initEventListeners();\r\n\r\n    return this.element;\r\n  }\r\n\r\n  renderForm() {\r\n    const element = document.createElement('div');\r\n\r\n    element.innerHTML = this.formData\r\n      ? this.template()\r\n      : this.getEmptyTemplate();\r\n\r\n    this.element = element.firstElementChild;\r\n    this.subElements = this.getSubElements(element);\r\n  }\r\n\r\n  getEmptyTemplate() {\r\n    return `<div>\r\n      <h1 class=\"page-title\">Страница не найдена</h1>\r\n      <p>Извините, данный товар не существует</p>\r\n    </div>`;\r\n  }\r\n\r\n  async save() {\r\n    const product = this.getFormData();\r\n    const result = await fetchJson(`${process.env.BACKEND_URL}api/rest/products`, {\r\n      method: 'PATCH',\r\n      headers: {\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify(product)\r\n    });\r\n\r\n    this.dispatchEvent(result.id);\r\n  }\r\n\r\n  getFormData() {\r\n    const {productForm, imageListContainer} = this.subElements;\r\n    const excludedFields = ['images'];\r\n    const formatToNumber = ['price', 'quantity', 'discount', 'status'];\r\n    const fields = Object.keys(this.defaultFormData).filter(item => !excludedFields.includes(item));\r\n    const values = {};\r\n\r\n    for (const field of fields) {\r\n      values[field] = formatToNumber.includes(field)\r\n        ? parseInt(productForm[field].value)\r\n        : productForm[field].value;\r\n    }\r\n\r\n    const imagesHTMLCollection = imageListContainer.querySelectorAll('.sortable-table__cell-img');\r\n\r\n    values.images = [];\r\n    values.id = this.productId;\r\n\r\n    for (const image of imagesHTMLCollection) {\r\n      values.images.push({\r\n        url: image.src,\r\n        source: image.alt\r\n      });\r\n    }\r\n\r\n    return values;\r\n  }\r\n\r\n  dispatchEvent(id) {\r\n    const event = this.productId\r\n      ? new CustomEvent('product-updated', {detail: id})\r\n      : new CustomEvent('product-saved');\r\n\r\n    this.element.dispatchEvent(event);\r\n  }\r\n\r\n  setFormData() {\r\n    const {productForm} = this.subElements;\r\n    const excludedFields = ['images'];\r\n    const fields = Object.keys(this.defaultFormData).filter(item => !excludedFields.includes(item));\r\n\r\n    fields.forEach(item => {\r\n      const element = productForm.querySelector(`#${item}`);\r\n\r\n      element.value = this.formData[item] || this.defaultFormData[item];\r\n    });\r\n  }\r\n\r\n  async loadProductData(productId) {\r\n    return await fetchJson(`${process.env.BACKEND_URL}api/rest/products?id=${productId}`);\r\n  }\r\n\r\n  async loadCategoriesList() {\r\n    return await fetchJson(`${process.env.BACKEND_URL}api/rest/categories?_sort=weight&_refs=subcategory`);\r\n  }\r\n\r\n  createCategoriesSelect() {\r\n    const wrapper = document.createElement('div');\r\n\r\n    wrapper.innerHTML = '<select class=\"form-control\" id=\"subcategory\" name=\"subcategory\"></select>';\r\n\r\n    const select = wrapper.firstElementChild;\r\n\r\n    for (const category of this.categories) {\r\n      for (const child of category.subcategories) {\r\n        select.append(new Option(`${category.title} > ${child.title}`, child.id));\r\n      }\r\n    }\r\n\r\n    return select.outerHTML;\r\n  }\r\n\r\n  getSubElements(element) {\r\n    const subElements = {};\r\n    const elements = element.querySelectorAll('[data-element]');\r\n\r\n    for (const item of elements) {\r\n      subElements[item.dataset.element] = item;\r\n    }\r\n\r\n    return subElements;\r\n  }\r\n\r\n  createImagesList() {\r\n    const {imageListContainer} = this.subElements;\r\n    const {images} = this.formData;\r\n\r\n    const items = images.map(({url, source}) => this.getImageItem(url, source));\r\n\r\n    const sortableList = new SortableList({\r\n      items\r\n    });\r\n\r\n    imageListContainer.append(sortableList.element);\r\n  }\r\n\r\n  getImageItem(url, name) {\r\n    const wrapper = document.createElement('div');\r\n\r\n    wrapper.innerHTML = `\r\n      <li class=\"products-edit__imagelist-item sortable-list__item\">\r\n        <span>\r\n          <img src=\"icon-grab.svg\" data-grab-handle alt=\"grab\">\r\n          <img class=\"sortable-table__cell-img\" alt=\"${escapeHtml(name)}\" src=\"${escapeHtml(url)}\">\r\n          <span>${escapeHtml(name)}</span>\r\n        </span>\r\n\r\n        <button type=\"button\">\r\n          <img src=\"icon-trash.svg\" alt=\"delete\" data-delete-handle>\r\n        </button>\r\n      </li>`;\r\n\r\n    return wrapper.firstElementChild;\r\n  }\r\n\r\n  initEventListeners() {\r\n    const {productForm, uploadImage} = this.subElements;\r\n\r\n    productForm.addEventListener('submit', this.onSubmit);\r\n    uploadImage.addEventListener('click', this.uploadImage);\r\n  }\r\n\r\n  destroy() {\r\n    this.remove();\r\n    this.element = null;\r\n    this.subElements = null;\r\n  }\r\n\r\n  remove() {\r\n    this.element.remove();\r\n  }\r\n}\r\n","import ProductForm from '../../../components/product-form/index.js';\r\n\r\nexport default class Page {\r\n  element;\r\n  subElements = {};\r\n  components = {};\r\n\r\n  constructor(match) {\r\n    this.match = match;\r\n  }\r\n\r\n  async initComponents () {\r\n    const [, productId] = this.match;\r\n    const productForm = new ProductForm(productId);\r\n    await productForm.render();\r\n    this.components.productForm = productForm;\r\n  }\r\n\r\n  get template () {\r\n    return `\r\n    <div class=\"products-edit\">\r\n      <div class=\"content__top-panel\">\r\n        <h1 class=\"page-title\">\r\n          <a href=\"/products\" class=\"link\">Товары</a> / Добавить\r\n        </h1>\r\n      </div>\r\n      <div class=\"content-box\">\r\n        <div data-element=\"productForm\">\r\n          <!-- product-form component -->\r\n        </div>\r\n      </div>\r\n    </div>`;\r\n  }\r\n\r\n  async render () {\r\n    const element = document.createElement('div');\r\n\r\n    element.innerHTML = this.template;\r\n\r\n    this.element = element.firstElementChild;\r\n    this.subElements = this.getSubElements(this.element);\r\n\r\n    await this.initComponents();\r\n\r\n    this.renderComponents();\r\n\r\n    return this.element;\r\n  }\r\n\r\n  renderComponents () {\r\n    Object.keys(this.components).forEach(component => {\r\n      const root = this.subElements[component];\r\n      const { element } = this.components[component];\r\n      root.append(element);\r\n    });\r\n  }\r\n\r\n  getSubElements ($element) {\r\n    const elements = $element.querySelectorAll('[data-element]');\r\n\r\n    return [...elements].reduce((accum, subElement) => {\r\n      accum[subElement.dataset.element] = subElement;\r\n\r\n      return accum;\r\n    }, {});\r\n  }\r\n\r\n  destroy () {\r\n    for (const component of Object.values(this.components)) {\r\n      component.destroy();\r\n    }\r\n  }\r\n}","// same as fetch, but throws FetchError in case of errors\r\n// status >= 400 is an error\r\n// network error / json error are errors\r\n\r\nexport default async function(url, params) {\r\n  let response;\r\n\r\n  try {\r\n    // NOTE: \"toString\" call needed for correct work of \"jest-fetch-mock\"\r\n    response = await fetch(url.toString(), params);\r\n  } catch(err) {\r\n    throw new FetchError(response, \"Network error has occurred.\");\r\n  }\r\n\r\n  let body;\r\n\r\n  if (!response.ok) {\r\n    let errorText = response.statusText; // Not Found (for 404)\r\n\r\n    try {\r\n      body = await response.json();\r\n\r\n      errorText = (body.error && body.error.message) || (body.data && body.data.error && body.data.error.message) || errorText;\r\n    } catch (error) { /* ignore failed body */ }\r\n\r\n    let message = `Error ${response.status}: ${errorText}`;\r\n\r\n    throw new FetchError(response, body, message);\r\n  }\r\n\r\n  try {\r\n    return await response.json();\r\n  } catch(err) {\r\n    throw new FetchError(response, null, err.message);\r\n  }\r\n}\r\n\r\nexport class FetchError extends Error {\r\n  name = \"FetchError\";\r\n\r\n  constructor(response, body, message) {\r\n    super(message);\r\n    this.response = response;\r\n    this.body = body;\r\n  }\r\n}\r\n\r\n// handle uncaught failed fetch through\r\nwindow.addEventListener('unhandledrejection', event => {\r\n  if (event.reason instanceof FetchError) {\r\n    alert(event.reason.message);\r\n  }\r\n});\r\n\r\n","export default string => string\r\n  .replace(/&/g, '&amp;')\r\n  .replace(/\"/g, '&quot;')\r\n  .replace(/'/g, '&#39;')\r\n  .replace(/</g, '&lt;')\r\n  .replace(/>/g, '&gt;');\r\n","export default class SortableList {\r\n  element;\r\n\r\n  onDocumentPointerMove = ({clientX, clientY}) => {\r\n    this.moveDraggingAt(clientX, clientY);\r\n\r\n    const {firstElementChild, children} = this.element;\r\n    const {top: firstElementTop} = firstElementChild.getBoundingClientRect();\r\n    const {bottom} = this.element.getBoundingClientRect();\r\n\r\n    if (clientY < firstElementTop) {\r\n      this.movePlaceholderAt(0);\r\n    } else if (clientY > bottom) {\r\n      this.movePlaceholderAt(children.length);\r\n    } else {\r\n      for (let i = 0; i < children.length; i++) {\r\n        const li = children[i];\r\n\r\n        // ignore to prevent bugs when dragging between elements\r\n        if (li !== this.draggingElem) {\r\n          const {top, bottom} = li.getBoundingClientRect();\r\n          const {offsetHeight: height} = li;\r\n\r\n          if (clientY > top && clientY < bottom) {\r\n            // inside the element (y-axis)\r\n            if (clientY < top + height / 2) {\r\n              // upper half of the element\r\n              this.movePlaceholderAt(i);\r\n              break;\r\n            } else {\r\n              // lower half of the element\r\n              this.movePlaceholderAt(i + 1);\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    this.scrollIfCloseToWindowEdge(clientY);\r\n  };\r\n\r\n  onDocumentPointerUp = () => {\r\n    this.dragStop();\r\n  };\r\n\r\n  constructor({items = []} = {}) {\r\n    this.items = items;\r\n\r\n    this.render();\r\n  }\r\n\r\n  render() {\r\n    this.element = document.createElement('ul');\r\n    this.element.className = 'sortable-list';\r\n\r\n    this.addItems();\r\n    this.initEventListeners();\r\n  }\r\n\r\n  initEventListeners() {\r\n    this.element.addEventListener('pointerdown', event => this.onPointerDown(event));\r\n  }\r\n\r\n  addItems() {\r\n    // item is a DOM element\r\n    for (let item of this.items) {\r\n      item.classList.add('sortable-list__item');\r\n    }\r\n\r\n    this.element.append(...this.items);\r\n  }\r\n\r\n  onPointerDown(event) {\r\n    if (event.which !== 1) { // must be left-button\r\n      return false;\r\n    }\r\n\r\n    const itemElem = event.target.closest('.sortable-list__item');\r\n\r\n    if (itemElem) {\r\n      if (event.target.closest('[data-grab-handle]')) {\r\n        event.preventDefault();\r\n\r\n        this.dragStart(itemElem, event);\r\n      }\r\n\r\n      if (event.target.closest('[data-delete-handle]')) {\r\n        event.preventDefault();\r\n\r\n        itemElem.remove();\r\n      }\r\n    }\r\n  }\r\n\r\n  dragStart(itemElem, {clientX, clientY}) {\r\n    this.elementInitialIndex = [...this.element.children].indexOf(itemElem);\r\n\r\n    this.pointerInitialShift = {\r\n      x: clientX - itemElem.getBoundingClientRect().x,\r\n      y: clientY - itemElem.getBoundingClientRect().y\r\n    };\r\n\r\n    this.draggingElem = itemElem;\r\n\r\n    this.placeholderElem = document.createElement('li');\r\n    this.placeholderElem.className = 'sortable-list__placeholder';\r\n\r\n    // itemElem will get position:fixed\r\n    // so its width will be auto-set to fit the parent container\r\n    itemElem.style.width = `${itemElem.offsetWidth}px`;\r\n    itemElem.style.height = `${itemElem.offsetHeight}px`;\r\n\r\n    this.placeholderElem.style.width = itemElem.style.width;\r\n    this.placeholderElem.style.height = itemElem.style.height;\r\n\r\n    itemElem.classList.add('sortable-list__item_dragging');\r\n\r\n    itemElem.after(this.placeholderElem);\r\n\r\n    // move to the end, to be over other list elements\r\n    this.element.append(itemElem);\r\n\r\n    this.moveDraggingAt(clientX, clientY);\r\n\r\n    document.addEventListener('pointermove', this.onDocumentPointerMove);\r\n    document.addEventListener('pointerup', this.onDocumentPointerUp);\r\n  }\r\n\r\n  moveDraggingAt(clientX, clientY) {\r\n    this.draggingElem.style.left = clientX - this.pointerInitialShift.x + 'px';\r\n    this.draggingElem.style.top = clientY - this.pointerInitialShift.y + 'px';\r\n  }\r\n\r\n  scrollIfCloseToWindowEdge(clientY) {\r\n    const scrollingValue = 10;\r\n    const threshold = 20;\r\n\r\n    if (clientY < threshold) {\r\n      window.scrollBy(0, -scrollingValue);\r\n    } else if (clientY > document.documentElement.clientHeight - threshold) {\r\n      window.scrollBy(0, scrollingValue);\r\n    }\r\n  }\r\n\r\n  movePlaceholderAt(index) {\r\n    const currentElement = this.element.children[index];\r\n\r\n    if (currentElement !== this.placeholderElem) {\r\n      this.element.insertBefore(this.placeholderElem, currentElement);\r\n    }\r\n  }\r\n\r\n  dragStop() {\r\n    const placeholderIndex = [...this.element.children].indexOf(this.placeholderElem);\r\n\r\n    // drop element back\r\n    this.placeholderElem.replaceWith(this.draggingElem);\r\n    this.draggingElem.classList.remove('sortable-list__item_dragging');\r\n\r\n    this.draggingElem.style.left = '';\r\n    this.draggingElem.style.top = '';\r\n    this.draggingElem.style.width = '';\r\n    this.draggingElem.style.height = '';\r\n\r\n    document.removeEventListener('pointermove', this.onDocumentPointerMove);\r\n    document.removeEventListener('pointerup', this.onDocumentPointerUp);\r\n\r\n    this.draggingElem = null;\r\n\r\n    if (placeholderIndex !== this.elementInitialIndex) {\r\n      this.element.dispatchEvent(new CustomEvent('sortable-list-reorder', {\r\n        bubbles: true,\r\n        details: {\r\n          from: this.elementInitialIndex,\r\n          to: placeholderIndex\r\n        }\r\n      }));\r\n    }\r\n  }\r\n\r\n  remove() {\r\n    this.element.remove();\r\n    document.removeEventListener('pointermove', this.onDocumentPointerMove);\r\n    document.removeEventListener('pointerup', this.onDocumentPointerUp);\r\n  }\r\n\r\n  destroy() {\r\n    this.remove();\r\n  }\r\n}\r\n"],"sourceRoot":""}